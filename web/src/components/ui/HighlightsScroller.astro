---
import weeklyHighlights from "../../data/weekly-highlights";

const highlights = weeklyHighlights.filter(
  (item) => item.text.trim().length > 0,
);
const isExternal = (href?: string) =>
  typeof href === "string" && /^https?:\/\//.test(href);
const hasMultipleSlides = highlights.length > 1;
---

{
  highlights.length > 0 ? (
    <section
      class="highlights-carousel"
      aria-label="Weekly highlights carousel"
    >
      <div class="highlights-carousel__header">
        <div class="highlights-carousel__heading-group">
          <p class="highlights-carousel__eyebrow">This week</p>
          <h2 class="highlights-carousel__heading">Church highlights</h2>
        </div>
        {hasMultipleSlides ? (
          <div
            class="highlights-carousel__controls"
            aria-label="Highlight slide controls"
          >
            <button
              class="highlights-carousel__control"
              data-dir="prev"
              type="button"
              aria-label="Previous highlight"
            >
              &larr;
            </button>
            <button
              class="highlights-carousel__control"
              data-dir="next"
              type="button"
              aria-label="Next highlight"
            >
              &rarr;
            </button>
          </div>
        ) : null}
      </div>

      <div class="highlights-carousel__viewport">
        <div class="highlights-carousel__track" role="list">
          {highlights.map((item, index) => (
            <article
              class="highlights-carousel__slide"
              role="listitem"
              data-slide-index={index}
            >
              <div class="highlights-carousel__card">
                <div class="highlights-carousel__badge-row">
                  {item.badge ? (
                    <span class="highlights-carousel__badge">{item.badge}</span>
                  ) : null}
                  {item.tag ? (
                    <span class="highlights-carousel__tag">{item.tag}</span>
                  ) : null}
                </div>
                <p class="highlights-carousel__text">
                  {item.href ? (
                    <a
                      href={item.href}
                      target={isExternal(item.href) ? "_blank" : undefined}
                      rel={isExternal(item.href) ? "noreferrer" : undefined}
                    >
                      {item.text}
                    </a>
                  ) : (
                    item.text
                  )}
                </p>
                {item.ctaHref && item.ctaLabel ? (
                  <a
                    class="highlights-carousel__cta"
                    href={item.ctaHref}
                    target={item.external ? "_blank" : undefined}
                    rel={item.external ? "noreferrer" : undefined}
                  >
                    {item.ctaLabel}
                  </a>
                ) : null}
              </div>
            </article>
          ))}
        </div>
      </div>

      {hasMultipleSlides ? (
        <div
          class="highlights-carousel__dots"
          role="tablist"
          aria-label="Highlight slide navigation"
        >
          {highlights.map((_, index) => (
            <button
              type="button"
              role="tab"
              class="highlights-carousel__dot"
              data-dot-index={index}
              aria-label={`Show highlight ${index + 1}`}
              aria-selected={index === 0 ? "true" : "false"}
            />
          ))}
        </div>
      ) : null}
    </section>
  ) : null
}

<script is:inline src="/scripts/highlights-carousel.js" defer></script>

<style>
  .highlights-carousel {
    margin: 0;
    border-radius: var(--radius-4);
    background:
      radial-gradient(
        150% 100% at 0% 0%,
        color-mix(in oklab, var(--color-primary) 16%, transparent) 0%,
        transparent 70%
      ),
      var(--color-surface);
    box-shadow: var(--shadow-2);
    border: 1px solid
      color-mix(in oklab, var(--color-border) 70%, var(--color-primary) 30%);
    position: relative;
    overflow: hidden;
    padding: clamp(var(--space-4), 2.2vw, var(--space-6));
    display: grid;
    gap: var(--space-4);
  }

  .highlights-carousel__header {
    display: flex;
    justify-content: space-between;
    align-items: end;
    gap: var(--space-3);
  }

  .highlights-carousel__heading-group {
    display: grid;
    gap: 0.25rem;
    min-width: 0;
  }

  .highlights-carousel__eyebrow {
    margin: 0;
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 800;
    color: var(--color-primary);
  }

  .highlights-carousel__heading {
    margin: 0;
    font-size: clamp(1.2rem, 0.98rem + 0.65vw, 1.5rem);
  }

  .highlights-carousel__controls {
    display: inline-flex;
    gap: var(--space-2);
  }

  .highlights-carousel__control {
    width: 2.2rem;
    height: 2.2rem;
    border-radius: 999px;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-primary);
    font-weight: 700;
    cursor: pointer;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .highlights-carousel__control:hover {
    background: var(--color-surface-muted);
  }

  .highlights-carousel__viewport {
    overflow: hidden;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-3);
    background: color-mix(
      in oklab,
      var(--color-surface) 95%,
      var(--color-surface-muted) 5%
    );
  }

  .highlights-carousel__track {
    display: flex;
    transition: transform 0.6s ease-in-out;
    will-change: transform;
  }

  .highlights-carousel__slide {
    flex: 0 0 100%;
    padding: clamp(var(--space-4), 2vw, var(--space-6));
  }

  .highlights-carousel__card {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .highlights-carousel__badge-row {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .highlights-carousel__badge,
  .highlights-carousel__tag {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.11em;
    padding: 0.28rem 0.72rem;
    border-radius: 999px;
  }

  .highlights-carousel__badge {
    background: color-mix(
      in oklab,
      var(--color-surface-muted) 70%,
      var(--color-primary) 30%
    );
    color: var(--color-primary);
  }

  .highlights-carousel__tag {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .highlights-carousel__text {
    margin: 0;
    font-weight: 650;
    font-size: clamp(1.03rem, 0.94rem + 0.33vw, 1.22rem);
    line-height: 1.42;
    color: var(--color-text);
  }

  .highlights-carousel__text a {
    color: var(--color-text);
    text-decoration-color: color-mix(
      in oklab,
      var(--color-primary) 30%,
      transparent 70%
    );
  }

  .highlights-carousel__text a:hover {
    text-decoration-color: var(--color-primary);
  }

  .highlights-carousel__cta {
    align-self: flex-start;
    font-weight: 700;
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 2px solid
      color-mix(in oklab, var(--color-primary) 40%, transparent 60%);
    padding-bottom: 0.12rem;
  }

  .highlights-carousel__cta:hover {
    border-bottom-color: var(--color-primary);
  }

  .highlights-carousel__dots {
    display: inline-flex;
    justify-content: center;
    gap: var(--space-2);
    padding: 0 var(--space-1) var(--space-1);
  }

  .highlights-carousel__dot {
    width: 0.55rem;
    height: 0.55rem;
    border-radius: 999px;
    border: 0;
    background: color-mix(
      in oklab,
      var(--color-border) 70%,
      var(--color-text-muted) 30%
    );
    cursor: pointer;
    padding: 0;
  }

  .highlights-carousel__dot[aria-selected="true"] {
    width: 1.35rem;
    background: var(--color-primary);
  }

  @media (prefers-reduced-motion: reduce) {
    .highlights-carousel__track {
      transition: none;
    }
  }

  @media (max-width: 720px) {
    .highlights-carousel {
      gap: var(--space-3);
      padding: var(--space-4);
    }

    .highlights-carousel__header {
      align-items: center;
    }

    .highlights-carousel__control {
      width: 2rem;
      height: 2rem;
    }
  }
</style>
