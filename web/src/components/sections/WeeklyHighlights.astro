---
import Button from "../ui/Button.astro";
import weeklyHighlights from "../../data/weekly-highlights";
import type { WeeklyHighlight } from "../../data/weekly-highlights";
import { recurringActivities } from "../../data/activities";

type HighlightConfig = WeeklyHighlight;

type HighlightCard = {
  id: string;
  title: string;
  description: string;
  tag?: string;
  timeLabel?: string;
  href?: string;
  ctaLabel: string;
  ctaExternal: boolean;
};

const highlightItems = weeklyHighlights
  .map((highlight: HighlightConfig) => {
    const source = recurringActivities.find((activity) => activity.id === highlight.activityId);
    if (!source) return null;

    const timePieces = [source.day, source.time].filter(Boolean);
    const timeLabel = timePieces.length ? timePieces.join(" Â· ") : undefined;
    const href = highlight.ctaHref ?? highlight.href ?? source.link;
    const ctaLabel = highlight.ctaLabel ?? "Learn more";
    const ctaExternal = typeof highlight.external === "boolean"
      ? highlight.external
      : typeof href === "string"
      ? /^https?:\/\//.test(href)
      : false;

    const card: HighlightCard = {
      id: source.id,
      title: highlight.title ?? source.title ?? highlight.text,
      description: highlight.description ?? source.cadence,
      tag: highlight.tag ?? source.category ?? undefined,
      timeLabel,
      href,
      ctaLabel,
      ctaExternal,
    };

    return card;
  })
  .filter((item): item is HighlightCard => Boolean(item));
---

{highlightItems.length > 0 ? (
  <section class="weekly-highlights" aria-label="Weekly highlights">
    <div class="weekly-highlights__header">
      <div>
        <p class="eyebrow">Weekly rhythm</p>
        <h2>This week at First Springfield</h2>
      </div>
      <p class="muted small">Swipe or scroll to explore the rhythm of worship and service.</p>
    </div>

    <div class="weekly-highlights__list" role="list">
      {highlightItems.map((item) => (
        <article class="weekly-highlights__card" role="listitem">
          {item.tag ? <span class="weekly-highlights__tag">{item.tag}</span> : null}
          <h3>{item.title}</h3>
          <p class="muted">{item.description}</p>
          {item.timeLabel ? (
            <p class="weekly-highlights__time muted">{item.timeLabel}</p>
          ) : null}
          {item.href ? (
            <Button href={item.href} variant="ghost" size="sm" external={item.ctaExternal}>
              {item.ctaLabel}
            </Button>
          ) : null}
        </article>
      ))}
    </div>
  </section>
) : null}

<style>
  .weekly-highlights > * {
    margin: 0;
  }

  .weekly-highlights__header {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .weekly-highlights__list {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: minmax(240px, 1fr);
    gap: var(--space-4);
    overflow-x: auto;
    padding-bottom: var(--space-2);
    scroll-snap-type: x proximity;
    -webkit-overflow-scrolling: touch;
  }

  .weekly-highlights__list::-webkit-scrollbar {
    height: 0.35rem;
  }

  .weekly-highlights__card {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-3);
    padding: var(--space-4);
    background: var(--color-surface);
    box-shadow: var(--shadow-1);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    min-height: 220px;
    scroll-snap-align: start;
  }

  .weekly-highlights__tag {
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--color-text-muted);
  }

  .weekly-highlights__time {
    font-size: 0.95rem;
  }

  @media (min-width: 960px) {
    .weekly-highlights__list {
      grid-auto-flow: unset;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      overflow-x: visible;
    }
  }
</style>
