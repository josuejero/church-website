---
import ContentCard from "../content/ContentCard.astro";
import { getCollection } from "astro:content";
import { site } from "../../data/site";

type Props = {
  title?: string;
  limit?: number;
  showViewAll?: boolean;
};

const { title = "Upcoming Events", limit = 3, showViewAll = true } = Astro.props;

const events = await getCollection("events", ({ data }) =>
  import.meta.env.PROD ? data.draft !== true : true
);

const now = new Date();
const upcoming = events
  .filter((e) => e.data.start >= now)
  .sort((a, b) => a.data.start.valueOf() - b.data.start.valueOf())
  .slice(0, limit);

const fmt = new Intl.DateTimeFormat(site.locale, {
  dateStyle: "medium",
  timeStyle: "short",
  timeZone: site.timeZone
});
---

<section class="stack">
  <div class="cluster cluster--between cluster--baseline cluster--loose">
    <h2>{title}</h2>
    {showViewAll && (
      <a class="link" href="/events">
        View all
      </a>
    )}
  </div>

  {upcoming.length === 0 ? (
    <p class="muted">No upcoming events are published yet.</p>
  ) : (
    <div class="grid--cards">
      {upcoming.map((e) => (
        <ContentCard
          href={`/events/${e.id}`}
          title={e.data.title}
          summary={e.data.summary}
          meta={fmt.format(e.data.start)}
          tags={e.data.tags}
        />
      ))}
    </div>
  )}
</section>
