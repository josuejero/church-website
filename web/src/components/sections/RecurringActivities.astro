---
import { oneOffEvents, recurringActivities } from "../../data/activities";
import type {
  ActivityCategory,
  RecurringActivity,
} from "../../data/activities";
import { site } from "../../data/site";
import SectionHeading from "../ui/SectionHeading.astro";

type Props = {
  title?: string;
  subtitle?: string;
  showNotes?: boolean;
};

const { title = "Activities", subtitle, showNotes = true } = Astro.props;

const now = new Date();
const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const fmtDate = new Intl.DateTimeFormat(site.locale, {
  dateStyle: "medium",
  timeZone: site.timeZone,
});
const fmtDateTime = new Intl.DateTimeFormat(site.locale, {
  dateStyle: "medium",
  timeStyle: "short",
  timeZone: site.timeZone,
});

const isFilled = (value?: string) =>
  Boolean(value && value.trim() && value !== "TBD");
const cleanedRecurring = recurringActivities.filter((activity) => {
  const title = activity.title?.trim();
  if (!title || title.toLowerCase().startsWith("etc")) {
    return false;
  }
  return isFilled(activity.cadence) || isFilled(activity.time);
});

const oneOffUpcoming = oneOffEvents
  .map((event) => {
    const startAt = new Date(event.start);
    return {
      ...event,
      startAt,
      hasTime: event.start.includes("T"),
    };
  })
  .filter((event) => {
    if (Number.isNaN(event.startAt.valueOf())) {
      return false;
    }
    return event.hasTime ? event.startAt >= now : event.startAt >= startOfToday;
  })
  .sort((a, b) => a.startAt.valueOf() - b.startAt.valueOf());

const buildScheduleLine = (activity: RecurringActivity) => {
  const parts: string[] = [];
  const day = activity.day?.trim();
  if (day) {
    parts.push(day);
  }
  const time = activity.time?.trim();
  if (time) {
    parts.push(time);
  }
  return parts.join(" Â· ");
};

const recurringGroupOrder: (ActivityCategory | "other")[] = [
  "service",
  "ministry",
  "community",
  "event",
  "other",
];

const activityGroupLabels: Record<ActivityCategory | "other", string> = {
  service: "Worship & service",
  ministry: "Study & discipleship",
  community: "Community & outreach",
  event: "Special events",
  other: "Other gatherings",
};

const groupedRecurring = cleanedRecurring.reduce<
  Record<ActivityCategory | "other", RecurringActivity[]>
>(
  (groups, activity) => {
    const key = (activity.category ?? "other") as ActivityCategory | "other";
    if (!groups[key]) {
      groups[key] = [];
    }
    groups[key].push(activity);
    return groups;
  },
  {} as Record<ActivityCategory | "other", RecurringActivity[]>,
);

const activeRecurringGroups = recurringGroupOrder.filter(
  (groupKey) => groupedRecurring[groupKey]?.length,
);

const describeRecurringActivity = (activity: RecurringActivity) => {
  const scheduleLine = buildScheduleLine(activity);
  const cadence = activity.cadence?.trim();
  const schedule = scheduleLine || cadence || "Details coming soon";
  const metadata =
    scheduleLine && cadence && cadence !== scheduleLine ? cadence : undefined;
  return { schedule, metadata };
};
---

<section class="stack">
  <SectionHeading title={title} subtitle={subtitle} />

  {
    oneOffUpcoming.length > 0 && (
      <div class="activity-section stack--tight">
        <h3 class="activity-section__title">One-off events</h3>
        <div class="activity-list" role="list">
          {oneOffUpcoming.map((event) => (
            <article class="activity-card" role="listitem">
              <p class="activity-card__schedule">
                {event.hasTime
                  ? fmtDateTime.format(event.startAt)
                  : fmtDate.format(event.startAt)}
              </p>
              <div class="activity-card__heading">
                {event.link ? (
                  <a class="activity-card__title" href={event.link}>
                    {event.title}
                  </a>
                ) : (
                  <span class="activity-card__title">{event.title}</span>
                )}
              </div>
              {showNotes && event.note && (
                <p class="activity-card__note">{event.note}</p>
              )}
            </article>
          ))}
        </div>
      </div>
    )
  }

  {
    activeRecurringGroups.length > 0 && (
      <div class="activity-section stack--tight">
        <h3 class="activity-section__title">Recurring activities</h3>
        {activeRecurringGroups.map((groupKey) => {
          const activities = groupedRecurring[groupKey] ?? [];
          return (
            <div class="activity-group">
              <h4 class="activity-group__heading">
                {activityGroupLabels[groupKey] ?? "Activities"}
              </h4>
              <div class="activity-list" role="list">
                {activities.map((activity) => {
                  const { schedule, metadata } =
                    describeRecurringActivity(activity);
                  return (
                    <article class="activity-card" role="listitem">
                      <p class="activity-card__schedule">{schedule}</p>
                      <div class="activity-card__heading">
                        {activity.link ? (
                          <a class="activity-card__title" href={activity.link}>
                            {activity.title}
                          </a>
                        ) : (
                          <span class="activity-card__title">
                            {activity.title}
                          </span>
                        )}
                      </div>
                      {metadata && (
                        <p class="activity-card__meta">{metadata}</p>
                      )}
                      {showNotes && activity.note && (
                        <p class="activity-card__note">{activity.note}</p>
                      )}
                    </article>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    )
  }
</section>

<style>
  .activity-section {
    display: grid;
    gap: var(--space-4);
  }

  .activity-section__title {
    margin: 0;
    font-size: var(--type-scale-h3-size);
  }

  .activity-group + .activity-group {
    margin-top: var(--space-4);
  }

  .activity-group__heading {
    margin: 0;
    font-size: 0.82rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 800;
    color: var(--color-primary);
    margin-bottom: var(--space-3);
  }

  .activity-list {
    display: grid;
    gap: var(--space-3);
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }

  .activity-card {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-3);
    background: var(--color-surface);
    box-shadow: var(--shadow-1);
    padding: var(--space-4);
    display: grid;
    gap: var(--space-3);
    height: 100%;
  }

  .activity-card__heading {
    display: flex;
    align-items: baseline;
  }

  .activity-card__title {
    font-size: clamp(1.08rem, 0.98rem + 0.33vw, 1.22rem);
    font-weight: 700;
    color: inherit;
    text-decoration: none;
    line-height: 1.35;
  }

  .activity-card__title:hover {
    text-decoration: underline;
  }

  .activity-card__schedule {
    margin: 0;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--color-primary);
    font-weight: 700;
  }

  .activity-card__meta {
    margin: 0;
    font-size: var(--font-size-1);
    color: var(--color-text-muted);
  }

  .activity-card__note {
    margin: 0;
    font-size: var(--font-size-0);
    color: var(--color-text-muted);
  }
</style>
