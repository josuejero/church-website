---
import BaseLayout from "../../layouts/BaseLayout.astro";
import HeroSection from "../../components/sections/Hero.astro";
import { getCollection, getEntry, render } from "astro:content";
import { mailto } from "../../lib/links";

export async function getStaticPaths() {
  const ministries = await getCollection("ministries", ({ data }) =>
    import.meta.env.PROD ? data.draft !== true : true
  );
  return ministries.map((m) => ({ params: { id: m.id } }));
}

const { id } = Astro.params;

const ministry = await getEntry("ministries", id!);
if (!ministry) throw new Error(`Ministry not found: ${id}`);

const data: any = (ministry as any).data ?? {};
const isFilled = (value?: string) => Boolean(value && value.trim() && value !== "TBD");
const meetingTime = isFilled(data.meetingTime) ? data.meetingTime : "";
const leaderName = isFilled(data.leaderName) ? data.leaderName : "";
const leaderEmail = isFilled(data.leaderEmail)
  ? data.leaderEmail
  : isFilled(data.contactEmail)
    ? data.contactEmail
    : "";
const fallbackMessage = "Contact us for current meeting details.";

const { Content } = await render(ministry);

const title =
  data.title ??
  (typeof id === "string"
    ? id.replace(/[-_]/g, " ").replace(/\b\w/g, (c) => c.toUpperCase())
    : "Ministry");

const description =
  data.description ?? data.summary ?? `Learn more about ${title}.`;
const heroSubtitle = data.summary ?? description;
---

<BaseLayout title={title} description={description}>
  <div class="stack">
    <HeroSection title={title} subtitle={heroSubtitle}>
      {meetingTime ? (
        <article slot="meta" class="hero__meta-item">
          <p class="hero__meta-label">Meeting time</p>
          <p class="hero__meta-value">{meetingTime}</p>
        </article>
      ) : (
        <article slot="meta" class="hero__meta-item">
          <p class="hero__meta-label">Meeting time</p>
          <p class="hero__meta-value">
            <a class="hero__meta-link" href="/connect/contact">{fallbackMessage}</a>
          </p>
        </article>
      )}

      <article slot="meta" class="hero__meta-item">
        <p class="hero__meta-label">Contact</p>
        {leaderName && <p class="hero__meta-leader">{leaderName}</p>}
        {leaderEmail ? (
          <a
            class="hero__meta-link hero__meta-email"
            href={mailto(leaderEmail, `${title} ministry`)}
          >
            {leaderEmail}
          </a>
        ) : (
          <a class="hero__meta-link" href="/connect/contact">{fallbackMessage}</a>
        )}
      </article>
    </HeroSection>

    <section class="card">
      <div class="prose">
        <Content />
      </div>
    </section>
  </div>
</BaseLayout>
