---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/ui/Hero.astro';
import ContentCard from '../../components/content/ContentCard.astro';
import RecurringActivities from '../../components/sections/RecurringActivities.astro';
import { getCollection } from 'astro:content';
import { site } from '../../data/site';

const events = await getCollection('events', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

const now = new Date();
const upcoming = events
  .filter((e) => e.data.start >= now)
  .sort((a, b) => a.data.start.valueOf() - b.data.start.valueOf());

const past = events
  .filter((e) => e.data.start < now)
  .sort((a, b) => b.data.start.valueOf() - a.data.start.valueOf())
  .slice(0, 12);

const fmt = new Intl.DateTimeFormat(site.locale, {
  dateStyle: 'medium',
  timeStyle: 'short',
  timeZone: site.timeZone,
});
---

<BaseLayout title="Events" description="What’s happening at church.">
  <Hero
    title="Events"
    subtitle="See what’s coming up and what we’ve recently hosted."
  />

  <section class="stack--loose">
    <RecurringActivities />

    <div class="stack">
      <h2>Upcoming</h2>

      {upcoming.length === 0 ? (
        <p class="muted">No upcoming events are published yet.</p>
      ) : (
        <div class="grid--cards">
          {upcoming.map((e) => (
            <ContentCard
              href={`/events/${e.id}`}
              title={e.data.title}
              summary={e.data.summary}
              meta={fmt.format(e.data.start)}
              tags={e.data.tags}
            />
          ))}
        </div>
      )}
    </div>

    <div class="stack">
      <h2>Recent</h2>
      {past.length === 0 ? (
        <p class="muted">No past events are published yet.</p>
      ) : (
        <div class="grid--cards">
          {past.map((e) => (
            <ContentCard
              href={`/events/${e.id}`}
              title={e.data.title}
              summary={e.data.summary}
              meta={fmt.format(e.data.start)}
              tags={e.data.tags}
            />
          ))}
        </div>
      )}
    </div>
  </section>
</BaseLayout>
